/*
 *  jQuery FireComments - v0.1.0
 *  Add a commenting system powered by Firebase to any page
 *  https://github.com/ximi/jquery-firecomments/
 *
 *  Made by Max (ximi)
 *  Under MIT License
 */
!function(a,b,c){"use strict";function d(b,c){this.element=b,this.$element=a(b),this.settings=a.extend({},e,c),this._defaults=e,this._name="firecomments",this.init()}var e={id:"1",parent_path:"posts",child_path:"comments",new_desc:!0,comments_container:'<section id="fire-comments"></section>',form:'<form id="fire-comment-form"></form>',form_before:!0},f={trimSlashes:function(a){return a=a.replace(/^\/+/,""),a=a.replace(/\/+$/,"")},nl2br:function(a){return(a+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},stripHtml:function(b){return a("<div></div>").html(b).text()},isInDom:function(b){return a.contains(c.documentElement,a(b)[0])}};d.prototype={init:function(){if(this.$comments_container=a(this.settings.comments_container),f.isInDom(this.$comments_container)||this.$comments_container.appendTo(this.$element),this.$form=a(this.settings.form),!f.isInDom(this.$form)){var b=this.settings.form_before?"prependTo":"appendTo";this.$form[b](this.$element)}this.renderForm(),this.connect(),this.setupEvents()},connect:function(){if("undefined"==typeof this.settings.firebase_url)throw new Error("No Firebase URL has been passed to fireComments");this.updateUrl();try{this.firebase=new Firebase(this.url)}catch(a){throw new Error("The following error occured while connecting to Firebase: "+a.message)}},updateUrl:function(){this.url=this.settings.firebase_url+(this.settings.parent_path?"/"+f.trimSlashes(this.settings.parent_path):"")+(this.settings.id?"/"+this.settings.id:"")+(this.settings.child_path?"/"+f.trimSlashes(this.settings.child_path):"")+"/"},setupEvents:function(){if(this.firebase){var a=this;this.firebase.on("child_added",function(b){a.renderComment(b)}),this.$form.on("submit",function(b){b.preventDefault(),a.saveComment()})}},renderComment:function(b){if(b){var c,d=b.val();if(a.isFunction(this.settings.renderComment))c=this.settings.renderComment.apply(this.element,[d]);else{var e='<article class="fire-comment">';e+='<div class="fire-comment-meta">',e+=d.website?'<a href="'+d.website+'" class="fire-commenter">'+d.name+"</a>":'<span class="fire-commenter">'+d.name+"</a>",e+="</div>",e+='<div class="fire-comment-content">',e+=d.content,e+="</div>",e+="</article>",c=e}if("undefined"!=typeof c){var f=this.settings.new_desc?"prepend":"append";this.$comments_container[f](c)}}},renderForm:function(){var b;if(a.isFunction(this.settings.renderForm))b=this.settings.renderForm.apply(this.element);else if(!this.$form.find("input, textarea").length){var c=this.renderFormGroup("Name","name","text");c+=this.renderFormGroup("Website","website","url"),c+=this.renderFormGroup("Comment","content","textarea",!0),c+='<input type="submit" value="Submit" />',b=c}"undefined"!=typeof b&&this.$form.html(b)},renderFormGroup:function(b,c,d,e){var f;if(a.isFunction(this.settings.renderFormGroup))f=this.settings.renderFormGroup.apply(this.element,[b,c,d,e]);else{var g='<div class="fire-comment-form-group">';g+='<label class="fire-comment-form-label" for="fire-comment-'+c+'">'+b+"</label>",g+="textarea"===d?"<textarea":'<input type="'+d+'"',g+=' name="fire-comment-'+c+'" id="fire-comment-'+c+'"',e&&(g+=' required="required"'),g+="textarea"===d?"></textarea>":" />",g+="</div>",f=g}return"undefined"!=typeof f?f:void 0},saveComment:function(){var b=this.$form.find("#fire-comment-name").val(),c=this.$form.find("#fire-comment-website").val(),d=this.$form.find("#fire-comment-content").val();b=a.trim(f.stripHtml(b)),c=a.trim(f.stripHtml(c)),d=a.trim(f.nl2br(f.stripHtml(d))),this.firebase.push({name:b,website:c,content:d})}},a.fn.fireComments=function(b){return this.each(function(){a.data(this,"firecomments")||a.data(this,"firecomments",new d(this,b))}),this}}(jQuery,window,document);